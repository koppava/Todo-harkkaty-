<!DOCTYPE html>
<!-- To run the current sample code in your own environment, copy this to an html page. -->

<html>
<head>
    <title>Todo Harkka</title>
    <script src="http://code.jquery.com/jquery.js"></script>
    
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    
    <!-- Pick a theme, load the plugin & initialize plugin -->
    <link href="scripts/tablesorter/themes/blue/style.css" rel="stylesheet">
    <script src="scripts/tablesorter/jquery.tablesorter.js"></script>
    
    <script src="scripts/jsviews.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="result"></div>
    
<script id="theTmpl" type="text/x-jsrender">
{{for tasks}}
    <tr class="{{if done == 1}}done{{else}}unfinished{{/if}}">
        <td>{{:task_name}}</td>\n\
        <td>{{:assignee}}</td>\n\
        <td>{{:deadline}}</td>\n\
        <td class="status">
            {{if done == 1}}
                <button data-id="{{:id}}" data-done="1" class="status btn-xs btn-success">Done</button>
            {{else}}
                <button data-id="{{:id}}" data-done="0" class="status btn-xs btn-danger">Unfinished</button>
            {{/if}}
        </td>
        <td><button class="btn-xs btn-primary">Edit</button><button class="btn-xs btn-warning">Delete</button></td>
    </tr>
{{/for}}
</script>

<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content row">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Add ToDo Item</h4>
            </div>
            <div class="modal-body">
                <label for="task-name" class="col-xs-6">Task Name:</label>
                <input id="task-name" class="col-xs-5" type="text" />
                <label for="assignee" class="col-xs-6">Assignee:</label>
                <input id="assignee" class="col-xs-5" type="text" />
                <label for="deadline" class="col-xs-6">Deadline:</label>
                <input id="deadline" class="col-xs-5" type="text" placeholder="e.g. 07-08-2014" />
                <button class="save btn btn-primary pull-right">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="col-xs-3">
    <h4>Show:</h4> 
    <span class="radio-container"><input id="show-done" name="show" checked="checked" type="radio" /> <label for="show-done">Done</label></span>
    <span class="radio-container"><input id="show-unfinished" name="show" type="radio" /> <label for="show-unfinished">Unfinished</label></span>
</div>
<div class="col-xs-3">
    <button class="add-todo btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-sm">Add ToDo item</button>
</div>

<table class="tablesorter">
    <thead>
        <tr>
            <th>Task Name</th>
            <th>Assignee</th>
            <th>Deadline</th>
            <th>Done</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="todo-table-content">
    </tbody>
</table>

<script>
    var template = $.templates("#theTmpl");
    
    function updateTable(initial, filter)
    {
        $.getJSON('index.php', function(data){
            $('#todo-table-content').html(template.render(data));
            $('#todo-table-content').trigger('update');
                
            if (initial) {
                $('table').tablesorter({
                    usNumberFormat : false,
                    sortReset      : true,
                    sortRestart    : true
                });
            }
            
            filter();
        });
    }
    
    function showDone()
    {
        $('.done').each(function(){
            $(this).show();
        });
        $('.unfinished').each(function(){
            $(this).hide();
        });
    }
    
    function showUnfinished()
    {
        $('.unfinished').each(function(){
            $(this).show();
        });
        $('.done').each(function(){
            $(this).hide();
        });
    }
    
    updateTable(true, showDone);
    
    $('#show-done').on('click', function() {
        showDone();
    });
    
    $('#show-unfinished').on('click', function() {
        showUnfinished();
    })
    
    $('body').on('click', '.save', function() {
        $.post(
            'index.php', 
            {
                'task_name': $('#task-name').val(),
                'assignee': $('#assignee').val(),
                'deadline': $('#deadline').val()
            },
            function (data) {
                updateTable(false, showUnfinished);
                
                $('.modal').modal('hide');
                $('#task-name').val('');
                $('#assignee').val('');
                $('#deadline').val('');
            },
            'json'
        );
    });
    
    $('body').on('click', '.status', function(event) {
        event.stopImmediatePropagation();
        var show = showDone;
        var data = {};
        data.id = $(this).data('id');
        if ($(this).data('done') == 0) {
            data.done = 1;
        }
        else if ($(this).data('done') == 1) {
            data.done = 0;
        }
        
        if ($('#show-unfinished').is(':checked')) {
            show = showUnfinished;
        }
        
        $.ajax({
            type: 'PUT',
            url: 'index.php',
            contentType: 'application/json',
            data: data,
            success: function() {
                updateTable(false, show);
            }
        });
    });
    
</script>

</body>
</html>
